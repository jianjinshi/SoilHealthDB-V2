target_ranges <- append(target_ranges, list(co2_index))
}
if (length(fastc_index) > 0) {
target_ranges <- append(target_ranges, list(fastc_index))
}
logRR_results <- soil_data %>% dplyr::select(StudyID, ExperimentID)
for (range in target_ranges) {
for (i in seq(range[1], range[length(range)], by = 6)) {
if ((i + 1) <= length(col_names)) {
C_col <- col_names[i]
T_col <- col_names[i + 1]
indicator <- gsub("_C$", "", C_col)
logRR_results[[paste0("logRR_", indicator)]] <- log(soil_data[[T_col]]) - log(soil_data[[C_col]])
}
}
}
names <- colnames(logRR_results %>% dplyr::select(starts_with("logRR_")))
cor_matrix <- matrix(NA, nrow = length(names), ncol = length(names))
p_matrix <- matrix(NA, nrow = length(names), ncol = length(names))
colnames(cor_matrix) <- rownames(cor_matrix) <- names
colnames(p_matrix) <- rownames(p_matrix) <- names
for (i in seq_along(names)) {
for (j in seq_along(names)) {
if (i != j) {
valid_data <- complete.cases(logRR_results[[names[i]]], logRR_results[[names[j]]])
if (sum(valid_data) > 2) {
test_result <- cor.test(logRR_results[[names[i]]][valid_data],
logRR_results[[names[j]]][valid_data],
method = "pearson")
cor_matrix[i, j] <- test_result$estimate
p_matrix[i, j] <- test_result$p.value
}
} else {
cor_matrix[i, j] <- 1
p_matrix[i, j] <- NA
}
}
}
cor_melt <- melt(cor_matrix, na.rm = FALSE)
p_melt <- melt(p_matrix, na.rm = FALSE)
cor_melt$p_value <- as.numeric(as.character(p_melt$value))
cor_melt$significance <- cut(cor_melt$p_value,
breaks = c(-Inf, 0.001, 0.01, 0.05, Inf),
labels = c("***", "**", "*", ""),
right = FALSE)
cor_melt$Var1 <- gsub("logRR_", "", cor_melt$Var1)
cor_melt$Var2 <- gsub("logRR_", "", cor_melt$Var2)
var_levels <- unique(c(cor_melt$Var1, cor_melt$Var2))
cor_melt$Var1 <- factor(cor_melt$Var1, levels = var_levels)
cor_melt$Var2 <- factor(cor_melt$Var2, levels = var_levels)
cor_melt_upper <- cor_melt %>% filter(match(Var1, var_levels) < match(Var2, var_levels))
cor_melt_lower <- cor_melt %>% filter(match(Var1, var_levels) > match(Var2, var_levels))
ggplot(cor_melt, aes(x = Var1, y = Var2, fill = value)) +
geom_tile(color = "gray") +
geom_text(data = cor_melt_upper, aes(label = round(value, 2)),
color = "black", size = 2.8) +
geom_text(data = cor_melt_lower, aes(label = significance),
color = "black", size = 4) +
scale_fill_gradient2(low = "#3D82BF", high = "#D54846", mid = "white", midpoint = 0, na.value = "gray") +
theme(axis.text.x = element_text(angle = 45, hjust = 1),
axis.text.y = element_text(size = 10)) +
coord_fixed(ratio = 1) +
labs(x = NULL, y = NULL)
ggsave("outputs/Figure 6.jpg", width = 10, height = 10, dpi = 300, units = "in")
ggsave("outputs/Figure 6.pdf", width = 10, height = 10, dpi = 300, units = "in")
SoilHealthDB <- read.csv("data/SoilHealthDB_V2.csv", header = T,
fileEncoding = "GBK",
na = c("", "NA"))
# YearAfterConservation=Sampling_year - Start_year
SoilHealthDB_CC <- SoilHealthDB %>%
filter(str_detect(Conservation_Type, "CC")) %>%
mutate(
YearAfterConservation = Sampling_year - Start_year,
Term = case_when(
YearAfterConservation >= 1 & YearAfterConservation <= 4 ~ "Short term",
YearAfterConservation >= 5 & YearAfterConservation <= 9 ~ "Medium term",
YearAfterConservation >= 10 ~ "Long term",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(Term))
par( mar=c(2, 0.2, 0.2, 0.2)
, mai=c(0.6, 0.7, 0.0, 0.1)
, omi = c(0.0, 0.1, 0.4, 0.1)
, mgp = c(0.5, 0.5, 0)
, tcl = 0.4
, cex.axis = 1.0
, mfrow=c(3,2) )
respcol <- respcol[-1]
for (term in c("Short term", "Medium term", "Long term")) {
subdata_term <- SoilHealthDB_CC %>% filter(Term == term)
for (i in c(1:5,7:(length(respcol)-2))) {
subdata <- subdata_term[, c(which(colnames(subdata_term) == 'StudyID' | colnames(subdata_term) == 'ExperimentID' | colnames(subdata_term) == 'Tillage_T')
, which(colnames(subdata_term) == respcol[i]), which(colnames(subdata_term) == respcol[i]) + 1
)]
subdata <- subdata[!is.na(subdata[,4]), ]
subdata$yi <- log(subdata[,5]) - log(subdata[,4])
if(any(is.infinite(subdata$yi))) {
subdata[is.infinite(subdata$yi),]$yi <- ifelse (subdata[is.infinite(subdata$yi),]$yi > 0,
max(subdata[is.finite(subdata$yi),]$yi),
min(subdata[is.finite(subdata$yi),]$yi))
}
if(nrow(subdata) < 3) {
next
}
subdata <- subdata[!is.na(subdata$yi),]
list_histo <- hist(subdata$yi, col='gray', breaks=50,
las = 1,
cex = 1,
main = "",
xlab = "",
ylab = "" )
box()
mtext(side = 1, text = expression("Response Ratio"), line = 1.75, cex=1, outer = F)
mtext(side = 2, text = expression("Frequency (n)"), line = 2.0, cex=1.0, outer = F)
# Shapiro-Wilk test
shapiro <- shapiro.test(subdata$yi)
shapiro_p <- shapiro$p.value
# QQ plot
qqPlot(subdata$yi,
las = 1,
cex = 1,
pch = 1,
main = "",
xlab = "",
ylab = "",
col.lines = 'red')
mtext(side = 1, text = expression("Normal theoretical quantiles"), line = 1.75, cex=1, outer = F)
mtext(side = 2, text = expression("Data quantiles"), line = 2.0, cex=1.0, outer = F)
# Other information
response <- colnames(subdata)[4]
response <- substr(response, 1, (nchar(response)-2))
n_obs <- length(subdata[,1])
n_study <- length(unique(subdata$StudyID))
mtext(side = 3, text = paste(response, " (", n_obs, "/", n_study, "/p=", round(shapiro_p, 3), ")", sep=""), line = 0.5, cex=1, outer = T)
print(paste("**********", term, i, response, "**********"))
}
}
boots_indicator <- function(sdata, column_name, n_rep = 5000) {
# Check if the column_name exists in data
if (!(column_name %in% names(sdata))) {
stop("Invalid column name.")
}
# Select relevant columns
subdata <- sdata[, c("StudyID", "ExperimentID", "Sampling_year", "Term", column_name,
colnames(sdata)[which(colnames(sdata) == column_name) + 1])]
# Compute log response ratio
subdata$yi <- log(subdata[,6]) - log(subdata[,5])
subdata <- subdata %>% filter(!is.na(yi))
if(nrow(subdata) < 3) { stop("Not enough data") }
# Handle infinite values
if(any(is.infinite(subdata$yi))) {
subdata[is.infinite(subdata$yi),]$yi <- ifelse(subdata[is.infinite(subdata$yi),]$yi > 0,
max(subdata[is.finite(subdata$yi),]$yi),
min(subdata[is.finite(subdata$yi),]$yi))
}
# Store results in a list
results_list <- list()
for (term in unique(subdata$Term)) {
subdata_term <- subdata %>% filter(Term == term)
if (nrow(subdata_term) < 3) {
next
}
# Bootstrap sampling
mysamples <- replicate(n_rep, sample(subdata_term$yi, replace = TRUE))
mymeans <- apply(mysamples, 2, mean, na.rm = TRUE)
# Compute confidence intervals
BootsTest <- quantile(mymeans, c(0.025, 0.50, 0.975))
# Store outputs
Boots_outputs <- tibble(
Term = term,
Indicator = column_name,
Low = (exp(BootsTest[[1]]) - 1) * 100,
Mean = (exp(BootsTest[[2]]) - 1) * 100,
High = (exp(BootsTest[[3]]) - 1) * 100,
obs = nrow(subdata_term),
n_study = length(unique(subdata_term$StudyID))
)
results_list[[term]] <- Boots_outputs
}
# Combine results
final_results <- bind_rows(results_list)
return(final_results)
}
n_rep = 5000
# Initialize results table
boots_outputs <- tibble(
Term = NA,
Indicator = NA,
Low = NA,
Mean = NA,
High = NA,
obs = NA,
n_study = NA,
y_variable = NA,
y = NA
)
# Run for each response variable
for(i in seq_along(respcol)) {
result <- tryCatch({
# Compute Bootstrap results for each indicator
boots_outputs2 <- boots_indicator(SoilHealthDB_CC, respcol[i], n_rep)
boots_outputs <- bind_rows(boots_outputs, boots_outputs2)
}, error = function(e) {
message(paste("Error for", respcol[i], ":", e$message))
NULL  # Return NULL if an error occurs
})
if (!is.null(result)) {
print(paste("Processed successfully for", respcol[i]))
}
}
boots_outputs <- boots_outputs %>%
filter(obs > 2 & Indicator != 'OC_C_Seq' & !is.na(Indicator)) %>%
mutate(y_variable = str_sub(Indicator, 1, -3)) %>%
mutate(y = row_number())
print(boots_outputs)
boots_outputs$y_variable <- factor(boots_outputs$y_variable, levels = rev(unique(boots_outputs$y_variable)))
# Ensure Term variable is a factor and ordered from Short term -> Medium term -> Long term
boots_outputs$Term <- factor(boots_outputs$Term, levels = c("Short term", "Medium term", "Long term"))
boots_outputs <- boots_outputs %>%
mutate(
label_text = ifelse(Mean < -100 | Mean > 100 | Low < -100 | High > 100,
paste0("(", round(Low, 2), ", ", round(Mean, 2), ", ", round(High, 2), ")"),
NA_character_)
)
ggplot(boots_outputs, aes(x = Mean, y = y_variable, color = Term)) +
geom_point(pch = 1, size = 2.5) +
geom_errorbarh(aes(xmin = Low, xmax = High), height = 0.3, size = 0.6,
data = boots_outputs %>% filter(Mean >= -100 & Mean <= 100 & Low >= -100 & High <= 100)) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 0.6) +
facet_wrap(~Term, scales = "fixed", dir = "h") +
labs(
x = expression(Response~to~cover~crop~'(%'~changes~")"),
y = "Soil health indicators"
) +
scale_x_continuous(breaks = seq(-100, 120, 20), labels = seq(-100, 120, 20)) +
xlim(-100, 125) +
scale_color_manual(values = c("Short term" = "orange", "Medium term" = "#0173B2", "Long term" = "black")) +  # Set colors
geom_text(aes(x = 95, label = paste0(obs, "/", n_study)), size = 3.5, hjust = 0) +
geom_text(aes(x = -25, label = label_text), size = 3.5, hjust = 0.5, vjust = 0, na.rm = TRUE) +  #
theme_bw() +
theme(
legend.position = "none",
strip.text = element_text(size = 12, face = "bold"),
axis.text.y = element_text(size = 10),
axis.title = element_text(size = 16)
)
ggsave("outputs/Figure 7.jpg", width = 12, height = 10, dpi = 300, units = "in")
ggsave("outputs/Figure 7.pdf", width = 12, height = 10, dpi = 300, units = "in")
SoilHealthDB <- read.csv("data/SoilHealthDB_V2.csv", header = T,
fileEncoding = "GBK",
na = c("", "NA"))
# YearAfterConservation=Sampling_year - Start_year
SoilHealthDB_CC <- SoilHealthDB %>%
filter(str_detect(Conservation_Type, "CC")) %>%
mutate(
YearAfterConservation = Sampling_year - Start_year,
Term = case_when(
YearAfterConservation >= 1 & YearAfterConservation <= 4 ~ "Short term",
YearAfterConservation >= 5 & YearAfterConservation <= 9 ~ "Medium term",
YearAfterConservation >= 10 ~ "Long term",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(Term))
par( mar=c(2, 0.2, 0.2, 0.2)
, mai=c(0.6, 0.7, 0.0, 0.1)
, omi = c(0.0, 0.1, 0.4, 0.1)
, mgp = c(0.5, 0.5, 0)
, tcl = 0.4
, cex.axis = 1.0
, mfrow=c(3,2) )
respcol <- respcol[-1]
for (term in c("Short term", "Medium term", "Long term")) {
subdata_term <- SoilHealthDB_CC %>% filter(Term == term)
for (i in c(1:5,7:(length(respcol)-2))) {
subdata <- subdata_term[, c(which(colnames(subdata_term) == 'StudyID' | colnames(subdata_term) == 'ExperimentID' | colnames(subdata_term) == 'Tillage_T')
, which(colnames(subdata_term) == respcol[i]), which(colnames(subdata_term) == respcol[i]) + 1
)]
subdata <- subdata[!is.na(subdata[,4]), ]
subdata$yi <- log(subdata[,5]) - log(subdata[,4])
if(any(is.infinite(subdata$yi))) {
subdata[is.infinite(subdata$yi),]$yi <- ifelse (subdata[is.infinite(subdata$yi),]$yi > 0,
max(subdata[is.finite(subdata$yi),]$yi),
min(subdata[is.finite(subdata$yi),]$yi))
}
if(nrow(subdata) < 3) {
next
}
subdata <- subdata[!is.na(subdata$yi),]
list_histo <- hist(subdata$yi, col='gray', breaks=50,
las = 1,
cex = 1,
main = "",
xlab = "",
ylab = "" )
box()
mtext(side = 1, text = expression("Response Ratio"), line = 1.75, cex=1, outer = F)
mtext(side = 2, text = expression("Frequency (n)"), line = 2.0, cex=1.0, outer = F)
# Shapiro-Wilk test
shapiro <- shapiro.test(subdata$yi)
shapiro_p <- shapiro$p.value
# QQ plot
qqPlot(subdata$yi,
las = 1,
cex = 1,
pch = 1,
main = "",
xlab = "",
ylab = "",
col.lines = 'red')
mtext(side = 1, text = expression("Normal theoretical quantiles"), line = 1.75, cex=1, outer = F)
mtext(side = 2, text = expression("Data quantiles"), line = 2.0, cex=1.0, outer = F)
# Other information
response <- colnames(subdata)[4]
response <- substr(response, 1, (nchar(response)-2))
n_obs <- length(subdata[,1])
n_study <- length(unique(subdata$StudyID))
mtext(side = 3, text = paste(response, " (", n_obs, "/", n_study, "/p=", round(shapiro_p, 3), ")", sep=""), line = 0.5, cex=1, outer = T)
print(paste("**********", term, i, response, "**********"))
}
}
View(SoilHealthDB)
respcol <- c("StudyID",
colnames(SoilHealthDB[, seq(which(colnames(SoilHealthDB) == "BiomassCash_C"),
which(colnames(SoilHealthDB) == "Texture_C"),
6)]))
str(respcol)
SoilHealthDB <- read.csv("data/SoilHealthDB_V2.csv", header = T,
fileEncoding = "GBK",
na = c("", "NA"))
# YearAfterConservation=Sampling_year - Start_year
SoilHealthDB_CC <- SoilHealthDB %>%
filter(str_detect(Conservation_Type, "CC")) %>%
mutate(
YearAfterConservation = Sampling_year - Start_year,
Term = case_when(
YearAfterConservation >= 1 & YearAfterConservation <= 4 ~ "Short term",
YearAfterConservation >= 5 & YearAfterConservation <= 9 ~ "Medium term",
YearAfterConservation >= 10 ~ "Long term",
TRUE ~ NA_character_
)
) %>%
filter(!is.na(Term))
par( mar=c(2, 0.2, 0.2, 0.2)
, mai=c(0.6, 0.7, 0.0, 0.1)
, omi = c(0.0, 0.1, 0.4, 0.1)
, mgp = c(0.5, 0.5, 0)
, tcl = 0.4
, cex.axis = 1.0
, mfrow=c(3,2) )
respcol <- respcol[-1]
for (term in c("Short term", "Medium term", "Long term")) {
subdata_term <- SoilHealthDB_CC %>% filter(Term == term)
for (i in c(1:5,7:(length(respcol)-2))) {
subdata <- subdata_term[, c(which(colnames(subdata_term) == 'StudyID' | colnames(subdata_term) == 'ExperimentID' | colnames(subdata_term) == 'Tillage_T')
, which(colnames(subdata_term) == respcol[i]), which(colnames(subdata_term) == respcol[i]) + 1
)]
subdata <- subdata[!is.na(subdata[,4]), ]
subdata$yi <- log(subdata[,5]) - log(subdata[,4])
if(any(is.infinite(subdata$yi))) {
subdata[is.infinite(subdata$yi),]$yi <- ifelse (subdata[is.infinite(subdata$yi),]$yi > 0,
max(subdata[is.finite(subdata$yi),]$yi),
min(subdata[is.finite(subdata$yi),]$yi))
}
if(nrow(subdata) < 3) {
next
}
subdata <- subdata[!is.na(subdata$yi),]
list_histo <- hist(subdata$yi, col='gray', breaks=50,
las = 1,
cex = 1,
main = "",
xlab = "",
ylab = "" )
box()
mtext(side = 1, text = expression("Response Ratio"), line = 1.75, cex=1, outer = F)
mtext(side = 2, text = expression("Frequency (n)"), line = 2.0, cex=1.0, outer = F)
# Shapiro-Wilk test
shapiro <- shapiro.test(subdata$yi)
shapiro_p <- shapiro$p.value
# QQ plot
qqPlot(subdata$yi,
las = 1,
cex = 1,
pch = 1,
main = "",
xlab = "",
ylab = "",
col.lines = 'red')
mtext(side = 1, text = expression("Normal theoretical quantiles"), line = 1.75, cex=1, outer = F)
mtext(side = 2, text = expression("Data quantiles"), line = 2.0, cex=1.0, outer = F)
# Other information
response <- colnames(subdata)[4]
response <- substr(response, 1, (nchar(response)-2))
n_obs <- length(subdata[,1])
n_study <- length(unique(subdata$StudyID))
mtext(side = 3, text = paste(response, " (", n_obs, "/", n_study, "/p=", round(shapiro_p, 3), ")", sep=""), line = 0.5, cex=1, outer = T)
print(paste("**********", term, i, response, "**********"))
}
}
boots_indicator <- function(sdata, column_name, n_rep = 5000) {
# Check if the column_name exists in data
if (!(column_name %in% names(sdata))) {
stop("Invalid column name.")
}
# Select relevant columns
subdata <- sdata[, c("StudyID", "ExperimentID", "Sampling_year", "Term", column_name,
colnames(sdata)[which(colnames(sdata) == column_name) + 1])]
# Compute log response ratio
subdata$yi <- log(subdata[,6]) - log(subdata[,5])
subdata <- subdata %>% filter(!is.na(yi))
if(nrow(subdata) < 3) { stop("Not enough data") }
# Handle infinite values
if(any(is.infinite(subdata$yi))) {
subdata[is.infinite(subdata$yi),]$yi <- ifelse(subdata[is.infinite(subdata$yi),]$yi > 0,
max(subdata[is.finite(subdata$yi),]$yi),
min(subdata[is.finite(subdata$yi),]$yi))
}
# Store results in a list
results_list <- list()
for (term in unique(subdata$Term)) {
subdata_term <- subdata %>% filter(Term == term)
if (nrow(subdata_term) < 3) {
next
}
# Bootstrap sampling
mysamples <- replicate(n_rep, sample(subdata_term$yi, replace = TRUE))
mymeans <- apply(mysamples, 2, mean, na.rm = TRUE)
# Compute confidence intervals
BootsTest <- quantile(mymeans, c(0.025, 0.50, 0.975))
# Store outputs
Boots_outputs <- tibble(
Term = term,
Indicator = column_name,
Low = (exp(BootsTest[[1]]) - 1) * 100,
Mean = (exp(BootsTest[[2]]) - 1) * 100,
High = (exp(BootsTest[[3]]) - 1) * 100,
obs = nrow(subdata_term),
n_study = length(unique(subdata_term$StudyID))
)
results_list[[term]] <- Boots_outputs
}
# Combine results
final_results <- bind_rows(results_list)
return(final_results)
}
n_rep = 5000
# Initialize results table
boots_outputs <- tibble(
Term = NA,
Indicator = NA,
Low = NA,
Mean = NA,
High = NA,
obs = NA,
n_study = NA,
y_variable = NA,
y = NA
)
# Run for each response variable
for(i in seq_along(respcol)) {
result <- tryCatch({
# Compute Bootstrap results for each indicator
boots_outputs2 <- boots_indicator(SoilHealthDB_CC, respcol[i], n_rep)
boots_outputs <- bind_rows(boots_outputs, boots_outputs2)
}, error = function(e) {
message(paste("Error for", respcol[i], ":", e$message))
NULL  # Return NULL if an error occurs
})
if (!is.null(result)) {
print(paste("Processed successfully for", respcol[i]))
}
}
boots_outputs <- boots_outputs %>%
filter(obs > 2 & Indicator != 'OC_C_Seq' & !is.na(Indicator)) %>%
mutate(y_variable = str_sub(Indicator, 1, -3)) %>%
mutate(y = row_number())
print(boots_outputs)
boots_outputs$y_variable <- factor(boots_outputs$y_variable, levels = rev(unique(boots_outputs$y_variable)))
# Ensure Term variable is a factor and ordered from Short term -> Medium term -> Long term
boots_outputs$Term <- factor(boots_outputs$Term, levels = c("Short term", "Medium term", "Long term"))
boots_outputs <- boots_outputs %>%
mutate(
label_text = ifelse(Mean < -100 | Mean > 100 | Low < -100 | High > 100,
paste0("(", round(Low, 2), ", ", round(Mean, 2), ", ", round(High, 2), ")"),
NA_character_)
)
ggplot(boots_outputs, aes(x = Mean, y = y_variable, color = Term)) +
geom_point(pch = 1, size = 2.5) +
geom_errorbarh(aes(xmin = Low, xmax = High), height = 0.3, size = 0.6,
data = boots_outputs %>% filter(Mean >= -100 & Mean <= 100 & Low >= -100 & High <= 100)) +
geom_vline(xintercept = 0, linetype = "dashed", color = "red", size = 0.6) +
facet_wrap(~Term, scales = "fixed", dir = "h") +
labs(
x = expression(Response~to~cover~crop~'(%'~changes~")"),
y = "Soil health indicators"
) +
scale_x_continuous(breaks = seq(-100, 120, 20), labels = seq(-100, 120, 20)) +
xlim(-100, 125) +
scale_color_manual(values = c("Short term" = "orange", "Medium term" = "#0173B2", "Long term" = "black")) +  # Set colors
geom_text(aes(x = 95, label = paste0(obs, "/", n_study)), size = 3.5, hjust = 0) +
geom_text(aes(x = -25, label = label_text), size = 3.5, hjust = 0.5, vjust = 0, na.rm = TRUE) +  #
theme_bw() +
theme(
legend.position = "none",
strip.text = element_text(size = 12, face = "bold"),
axis.text.y = element_text(size = 10),
axis.title = element_text(size = 16)
)
ggsave("outputs/Figure 7.jpg", width = 12, height = 10, dpi = 300, units = "in")
ggsave("outputs/Figure 7.pdf", width = 12, height = 10, dpi = 300, units = "in")
